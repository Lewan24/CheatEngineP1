@using CheatEngineP1.Interfaces
@using CheatAppSample.Components.Pages.Components
@using CheatAppSample.Data.Services

@inject IProcessMemoryReader CheatReaderService
@inject ServiceDataUpdater ServiceDataUpdater
@inject ISnackbar Snackbar

@page "/"

<MudContainer Class="mt-4 p-2 d-flex flex-column align-items-center">
    <MudContainer Class="d-flex flex-row justify-center gap-4">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@StartService" Disabled="@(ServiceDataUpdater.IsServiceStarted)">Start Service</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@StopService" Disabled="@(!ServiceDataUpdater.IsServiceStarted)">Stop Service</MudButton>
    </MudContainer>
    
    <CurrentCharacterStatsComponent/>
    <EqManagerComponent />
    <CharacterStatsComponent />
    
</MudContainer>

@code{
    protected override void OnInitialized()
    {
        CheatReaderService.Initialize("Palworld-Win64-Shipping");
    }

    private async Task StartService()
    {
        ServiceDataUpdater.IsServiceStarted = true;
        
        try
        {
            while (ServiceDataUpdater.IsServiceStarted)
            {
                ServiceDataUpdater.TriggerUpdate();
                
                await Task.Delay(200);
            }
        }
        catch (Exception e)
        {
            StopService();
            Snackbar.Add(e.Message, Severity.Error);
        }
    }
    
    private void StopService()
    {
        ServiceDataUpdater.IsServiceStarted = false;
        StateHasChanged();
    }
}